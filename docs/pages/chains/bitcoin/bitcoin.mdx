# Bitcoin Chain Implementation

The Bitcoin chain implementation supports both Bitcoin mainnet and testnet networks, with a focus on P2WPKH (Native SegWit) transactions.

## Configuration

```ts twoslash filename="base.ts"
// [!include ~/snippets/contract.ts]
// ---cut---
import { Bitcoin, BTCRpcAdapters } from 'signet.js'

// Initialize the RPC adapter using Mempool
const btcRpcAdapter = new BTCRpcAdapters.Mempool('https://mempool.space/api')

// Initialize the chain
const bitcoinChain = new Bitcoin({
  network: 'testnet', // 'mainnet' | 'testnet' | 'regtest'
  contract,
  btcRpcAdapter,
})
```

## Methods

### getBalance

Gets the BTC balance of an address.

```ts twoslash
// [!include base.ts]
// ---cut---
const balance = await bitcoinChain.getBalance(
  'bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh'
)
```

**Parameters:**

- `address`: The Bitcoin address to check

**Returns:**

- The balance in BTC as a string

### deriveAddressAndPublicKey

Derives a Bitcoin address and public key for a given path.

```ts twoslash
// [!include base.ts]
// ---cut---
const { address, publicKey } = await bitcoinChain.deriveAddressAndPublicKey(
  'predecessor_id',
  'any_string'
)
```

**Parameters:**

- `predecessor`: The ID of the signer to derive from
- `path`: The derivation path to use

**Returns:**

- Object containing:
  - `address`: The derived Bitcoin P2WPKH address
  - `publicKey`: The corresponding compressed public key

### getMPCPayloadAndTransaction

Prepares a transaction for MPC signing.

```ts twoslash filename="unsigned-transaction.ts"
// [!include base.ts]
// ---cut---
import { BTCTransactionRequest } from 'signet.js'

// Simple transfer format
const transactionRequest: BTCTransactionRequest = {
  from: 'bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh',
  to: 'bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4',
  value: '0.001', // 0.001 BTC
  publicKey: '0235a3...',
}

const { transaction: unsignedTransaction, mpcPayloads } =
  await bitcoinChain.getMPCPayloadAndTransaction(transactionRequest)
```

**Parameters:**

- `transactionRequest`: Either:
  - Simple format:
    ```ts
    {
      from: string // Source address
      to: string // Destination address
      value: string // Amount in BTC
      publicKey: string // Signer's public key
    }
    ```
  - Advanced format (manual UTXO selection):
    ```ts
    {
      inputs: BTCInput[]   // Selected UTXOs
      outputs: BTCOutput[] // Transaction outputs
      publicKey: string    // Signer's public key
    }
    ```

**Returns:**

- Object containing:
  - `transaction`: The unsigned transaction with PSBT
  - `mpcPayloads`: Array of payloads to be signed

### addSignature

Adds signatures to a PSBT.

```ts twoslash filename="add-signature.ts"
// [!include unsigned-transaction.ts]
// ---cut---
import { RSVSignature } from 'signet.js'

// Ideally it would be a request to the Sig Network Smart Contract
const mpcSignatures: RSVSignature[] = [
  {
    r: '0x...',
    s: '0x...',
    v: 27,
  },
]

const signedTx = bitcoinChain.addSignature({
  transaction: unsignedTransaction,
  mpcSignatures,
})
```

**Parameters:**

- `transaction`: The unsigned transaction with PSBT
- `mpcSignatures`: Array of RSV signatures from MPC

**Returns:**

- The serialized signed transaction in hex format

### broadcastTx

Broadcasts a signed transaction to the network.

```ts twoslash filename="broadcast-tx.ts"
// [!include add-signature.ts]
// ---cut---
const txid = await bitcoinChain.broadcastTx(signedTx)
```

**Parameters:**

- `txSerialized`: The serialized transaction in hex format

**Returns:**

- The transaction ID (txid)

## Technical Details

The implementation:

- Uses `bitcoinjs-lib` for transaction handling
- Supports P2WPKH (Native SegWit) addresses
- Handles automatic UTXO selection and change outputs
- Supports custom fee rates through the RPC adapter
- Uses PSBT (Partially Signed Bitcoin Transactions)
- Supports both mainnet and testnet networks
